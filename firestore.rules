rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================
    // FUNCIONES HELPER - CUSTOM CLAIMS
    // ============================================
    
    /**
     * Verifica que el usuario está autenticado
     */
    function isAuthenticated() {
      return request.auth != null;
    }
    
    /**
     * Verifica que el usuario es el dueño del recurso
     */
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    /**
     * Verifica que el usuario es admin
     * NUEVA VERSIÓN - Usa Custom Claims (sin get() a Firestore)
     */
    function isAdmin() {
      return isAuthenticated() && 
             request.auth.token.admin == true;
    }
    
    /**
     * Verifica que el usuario tiene un role específico
     * NUEVA VERSIÓN - Usa Custom Claims (sin get() a Firestore)
     */
    function hasRole(role) {
      return isAuthenticated() && 
             request.auth.token.role == role;
    }
    
    /**
     * Verifica que el usuario tiene uno de varios roles
     */
    function hasAnyRole(roles) {
      return isAuthenticated() && 
             request.auth.token.role in roles;
    }
    
    /**
     * Verifica que el usuario es admin o moderator
     */
    function canModerate() {
      return isAuthenticated() && 
             request.auth.token.role in ['admin', 'moderator'];
    }
    
    /**
     * Verifica que el usuario puede publicar recursos
     */
    function canPublishResources() {
      return isAuthenticated() && 
             request.auth.token.role in ['admin', 'verified_seller'];
    }
    
    /**
     * Verifica que el usuario puede dar capacitaciones
     */
    function canGiveTraining() {
      return isAuthenticated() && 
             request.auth.token.role in ['admin', 'moderator', 'corporate_pro', 'verified_seller', 'verified_pro'];
    }
    
    /**
     * Validación de email
     */
    function isValidEmail(email) {
      return email.matches('^[^@]+@[^@]+\\.[^@]+$');
    }
    
    /**
     * USERS - Perfiles de usuario
     */
    match /users/{userId} {
      // Lectura: Cualquier usuario autenticado
      allow read: if isAuthenticated();
      
      // Creación: Solo cuando el usuario se registra (auth.uid == userId)
      allow create: if isOwner(userId) && 
                      request.resource.data.role == 'user' && // Role inicial siempre 'user'
                      request.resource.data.userType in ['general', 'electrician', 'corporate_pro', 'retailer', 'distributor', 'manufacturer', 'buyer', 'student'];
      
      // Actualización: Propio usuario o admin
      allow update: if (isOwner(userId) || isAdmin()) &&

                      // CAMPOS QUE NO SE PUEDEN MODIFICAR
                      request.resource.data.uid == resource.data.uid &&

                      request.resource.data.email == resource.data.email &&

                      request.resource.data.createdAt == resource.data.createdAt &&

                      // ROLE SOLO PUEDE SER CAMBIADO POR ADMIN
                      (isAdmin() || request.resource.data.role == resource.data.role) &&

                      // CONTADORES NO SE PUEDEN MODIFICAR MANUALMENTE
                      request.resource.data.followersCount == resource.data.followersCount &&

                      request.resource.data.followingCount == resource.data.followingCount &&

                      request.resource.data.projectsCount == resource.data.projectsCount;
      
      // Eliminación: Solo admin
      allow delete: if isAdmin();
    }
    
    // ============================================================================
    // PROJECTS COLLECTION
    // ============================================================================
    match /projects/{projectId} {
      allow read: if true; // Portafolios públicos
      allow create: if isAuthenticated() &&
                       request.resource.data.createdBy == request.auth.uid &&
                       // Verificar campos requeridos (permitir campos opcionales adicionales)
                       'title' in request.resource.data &&
                       'description' in request.resource.data &&
                       'status' in request.resource.data &&
                       'category' in request.resource.data &&
                       'budget' in request.resource.data &&
                       'location' in request.resource.data &&
                       'clientName' in request.resource.data &&
                       'createdBy' in request.resource.data &&
                       'createdAt' in request.resource.data &&
                       'images' in request.resource.data &&
                       'tags' in request.resource.data &&
                       request.resource.data.status in ['Pendiente', 'En Progreso', 'Completado'] &&
                       request.resource.data.category in ['Residencial', 'Comercial', 'Industrial', 'Solar'] &&
                       request.resource.data.budget is number &&
                       request.resource.data.budget >= 0; // Permitir budget 0
      allow update: if isAuthenticated() &&
                       (resource.data.createdBy == request.auth.uid || isAdmin()) &&
                       !('createdBy' in request.resource.data.diff(resource.data).affectedKeys()) &&
                       !('createdAt' in request.resource.data.diff(resource.data).affectedKeys());
      allow delete: if isAuthenticated() &&
                       (resource.data.createdBy == request.auth.uid || isAdmin());
    }
    
    // ============================================================================
    // COMMENTS COLLECTION (Project Comments)
    // ============================================================================
    match /comments/{commentId} {
      allow read: if true; // Comentarios públicos
      allow create: if isAuthenticated() &&
                       request.resource.data.userId == request.auth.uid &&
                       // Verificar campos requeridos (createdAt puede ser serverTimestamp)
                       'projectId' in request.resource.data &&
                       'userId' in request.resource.data &&
                       'userDisplayName' in request.resource.data &&
                       'content' in request.resource.data &&
                       request.resource.data.content is string &&
                       request.resource.data.content.size() > 0 &&
                       request.resource.data.content.size() <= 1000;
      allow update: if isAuthenticated() &&
                       (resource.data.userId == request.auth.uid || isAdmin()) &&
                       request.resource.data.content is string &&
                       request.resource.data.content.size() > 0 &&
                       request.resource.data.content.size() <= 1000;
      allow delete: if isAuthenticated() &&
                       (resource.data.userId == request.auth.uid || isAdmin());
    }
    
    /**
     * BLOG-POSTS - Posts del blog
     */
    match /blog-posts/{postId} {
      allow read: if true; // Público
      // ACTUALIZADO: Solo admin y moderator pueden crear
      allow create: if canModerate();
      allow update: if isOwner(resource.data.authorId) || canModerate();
      allow delete: if isOwner(resource.data.authorId) || canModerate();
    }
    
    /**
     * BLOG-COMMENTS - Comentarios en blog
     */
    match /blog-comments/{commentId} {
      allow read: if true; // Público
      allow create: if isAuthenticated() &&
                      request.resource.data.content.size() >= 1 &&
                      request.resource.data.content.size() <= 1000;
      allow update: if isOwner(resource.data.userId) || canModerate();
      allow delete: if isOwner(resource.data.userId) || canModerate();
    }
    
    // ============================================================================
    // BLOG LIKES COLLECTION
    // ============================================================================
    match /blog-likes/{likeId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() &&
                       request.resource.data.userId == request.auth.uid &&
                       request.resource.data.keys().hasAll(['postId', 'userId', 'createdAt']);
      allow delete: if isAuthenticated() &&
                       resource.data.userId == request.auth.uid;
    }
    
    // ============================================================================
    // FOLLOWERS COLLECTION
    // ============================================================================
    match /followers/{followId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() &&
                       request.resource.data.followerId == request.auth.uid &&
                       request.resource.data.keys().hasAll(['followerId', 'followingId', 'followerName', 'followingName', 'createdAt']) &&
                       request.resource.data.followerId != request.resource.data.followingId; // No seguirse a sí mismo
      allow delete: if isAuthenticated() &&
                       resource.data.followerId == request.auth.uid;
    }
    
    /**
     * REVIEWS - Reseñas de usuarios
     */
    match /reviews/{reviewId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() &&
                      request.resource.data.reviewerId == request.auth.uid &&
                      request.resource.data.reviewedUserId != request.auth.uid && // No auto-reseña
                      request.resource.data.rating >= 1 &&
                      request.resource.data.rating <= 5 &&
                      request.resource.data.comment.size() >= 10 &&
                      request.resource.data.comment.size() <= 1000;
      allow update: if isOwner(resource.data.reviewerId) || isAdmin();
      allow delete: if isOwner(resource.data.reviewerId) || isAdmin();
    }
    
    // ============================================================================
    // USER RATINGS COLLECTION (Calculated ratings)
    // ============================================================================
    match /user-ratings/{userId} {
      allow read: if isAuthenticated();
      allow write: if false; // Solo se actualiza mediante Cloud Functions o transacciones del servidor
    }
    
    /**
     * RESOURCES - Recursos/Productos
     */
    match /resources/{resourceId} {
      // Lectura: Público si isPublic=true, sino solo admin
      allow read: if resource.data.isPublic == true || isAdmin();
      // ACTUALIZADO: Solo admin y verified_seller pueden crear
      allow create: if canPublishResources();
      allow update: if isOwner(resource.data.createdBy) || isAdmin();
      allow delete: if isAdmin(); // Solo admin puede eliminar
    }
    
    // ============================================================================
    // RESOURCE LIKES COLLECTION
    // ============================================================================
    match /resource-likes/{likeId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() &&
                       request.resource.data.userId == request.auth.uid &&
                       request.resource.data.keys().hasAll(['userId', 'resourceId', 'createdAt']);
      allow delete: if isAuthenticated() &&
                       resource.data.userId == request.auth.uid;
    }
    
    /**
     * COMMUNITY-POSTS - Posts de comunidad
     */
    match /community-posts/{postId} {
      allow read: if true; // Público
      allow create: if isAuthenticated();
      allow update: if isOwner(resource.data.userId) || canModerate();
      allow delete: if isOwner(resource.data.userId) || canModerate();
    }
    
    /**
     * POST-COMMENTS - Comentarios en posts de comunidad
     */
    match /post-comments/{commentId} {
      allow read: if true; // Público
      allow create: if isAuthenticated() &&
                      request.resource.data.content.size() >= 1 &&
                      request.resource.data.content.size() <= 1000;
      allow update: if isOwner(resource.data.userId) || canModerate();
      allow delete: if isOwner(resource.data.userId) || canModerate();
    }
    
    // ============================================================================
    // POST LIKES COLLECTION (Community)
    // ============================================================================
    match /post-likes/{likeId} {
      // Permitir ver quién dio like (lectura pública)
      allow read: if true;
      allow create: if isAuthenticated() &&
                       request.resource.data.userId == request.auth.uid &&
                       request.resource.data.keys().hasAll(['postId', 'userId', 'createdAt']);
      allow delete: if isAuthenticated() &&
                       resource.data.userId == request.auth.uid;
    }
    
    // ============================================================================
    // DEFAULT DENY
    // ============================================================================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}

